用SAC快速拾取震相
#################

:date: 2016-02-19
:modified: 2016-02-28
:author: SeisMan
:category: SAC
:tags: SAC技巧
:slug: faster-ppk

.. contents::

震相拾取，是地震学的一个基本工作。SAC提供了 ``plotpk`` 命令，可以用于手动拾取震相到时，用起来还算是比较简单方便。

痛点
====

在使用 ``plotpk`` 拾取震相时，还是会遇到一些不如意的地方。尤其是在有大量波形数据需要拾取的时候。下面列出我日常遇到的几个痛点：

#. 拾取震相时通常需要按下 ``T`` 和数字键，有时还需要按下 ``B`` 或 ``N`` 来上下翻页。效率低下，一方面需要按两次按键才能标记一个到时，另一方面大多数数字键与 ``T`` 距离较远，手指姿势比较别扭且容易误敲键盘
#. 无法删除某个震相标记。如果想标记T0，但是一不小心标记了T1，此时没法将T1中的到时删除

解决办法
========

修改了SAC源码中的 ``xppk.c`` ，基本解决了以上痛点。关于源码的几点说明：

#. SAC的协议规定了不能私自修改SAC源码，此处给出了修改后的 ``xppk.c`` ，低调低调
#. 修改版源码基于SAC v101.6a，所以在其他版本上可能无法使用
#. 下载修改版源码，用其覆盖SAC v101.6a源码里的 ``src/gam/xppk.c`` ，然后重新编译SAC即可

源码下载： `xppk.c <http://7j1zxm.com1.z0.glb.clouddn.com/downloads/xppk.c>`_

修改后的源码新增了如下功能：

#. 直接使用数字键拾取震相，即省略了按键 ``T`` ，按 ``0`` 就拾取到时T0，按 ``1`` 就拾取到时T1
#. 按下 ``@`` 键即可删除最近一次到时标记（A、F、P、S以及T0到T9）

修改后的源码与原SAC有如下不兼容的地方：

#. 原SAC中，数字键0到4被用于定义震相质量，修改后的源码中0到9则被用于标记震相到时
#. 原SAC中，按键 ``@`` 用于一次性删除多个震相到时（A、F、P、S和T0），修改后的源码中 ``@`` 可以删除任意一个到时标记

考虑到定义震相质量和一次性删除多个震相到时这两个功能很少用到，因而为了拾取震相的便利性而废弃了这两个功能，虽然带来了不兼容问题，但是基本无伤大雅。

一些说明
========

关于数字键标记到时的说明：

#. 依然可以使用 ``T+数字键`` 来标记到时。即， ``T`` 可以省略也可以不省略，兼容之前的标记到时的方法
#. 在ppk模式下单击鼠标，相当于敲键 ``L`` ，此时会在图上显示当前点的X和Y值，所以如果可以通过简单的单击就标记到时，应该会更高效。但目前还没有实现该功能，一方面是涉及到一些技术细节，另一方面是单击操作太容易发生，标记到时是变得简单了，但误标记也变得容易发生

关于 ``@`` 删除震相到时功能的说明：

#. 实现原理：定义一个字符型变量，用于保存上一次按键，若新按键是 ``@`` ，且上一按键是A、F、P、S或0到9中的任意一个，则删除上一按键所对应的头段变量中的到时标记
#. 表面上看，这一功能只能删除最近一次的到时标记，但实际上是可以删除任意文件的任意一个到时标记的

关于 ``@`` 删除震相到时功能的示例：

#. 要拾取一个波形数据，在ppk模式下，按下数字1，此时会标记到时T1，再按下@，由于上一字符是1，所以此时按下@会删除T1的到时标记。实际操作时，屏幕上会出现两个T1，这是显示的问题，通过放大缩小刷新一下图片就会发现到时T1已被删除
#. 要拾取一个波形数据，在ppk模式下依次按下0、1、2，此时会标记到时T0、T1和T2。此时按下@，由于上一字符是2，所以会删除T2中的到时。若想要删除T0的到时，则需要先按下0再按下@，按下0会重新标记到时T0，再按下@时上一字符由于是0，所以会删除T0中的到时。

修订历史
========

- 2016-02-19：直接用数字键标记到时
- 2016-02-25：新增删除到时标记功能
- 2016-02-28：修复了@符号无法删除P和S到时的BUG
